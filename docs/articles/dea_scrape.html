<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scraping drug names and slang from web pages. • DOPE</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Scraping drug names and slang from web pages.">
<meta property="og:description" content="DOPE">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">DOPE</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/controlled.html">How the dea_controlled file was made.</a>
    </li>
    <li>
      <a href="../articles/dea_scrape.html">Scraping drug names and slang from web pages.</a>
    </li>
    <li>
      <a href="../articles/dea_street_names.html">How the dea_street_names file was made.</a>
    </li>
    <li>
      <a href="../articles/Intro.html">Introduction to DOPE</a>
    </li>
    <li>
      <a href="../articles/make_lookup_df.html">Make Lookup Table</a>
    </li>
    <li>
      <a href="../articles/noslang_street_names.html">How the noslang_stret_names file was made.</a>
    </li>
    <li>
      <a href="../articles/parse_lookup.html">Introduction to parse and the lookup_ functions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/CTN-0094/DOPE/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="dea_scrape_files/header-attrs-2.8/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Scraping drug names and slang from web pages.</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/CTN-0094/DOPE/blob/master/vignettes/dea_scrape.Rmd"><code>vignettes/dea_scrape.Rmd</code></a></small>
      <div class="hidden name"><code>dea_scrape.Rmd</code></div>

    </div>

    
    
<p>This article assumes you have a basic understanding of what “scraping” is, so we will not get into the weeds on theory but more on the application in R using just a few packages: <code>rvest</code>, <code>dplyr</code> and <code>stringr</code>.</p>
<p>Before we start, let me point you to the <code>rvest</code> <a href="https://rvest.tidyverse.org/index.html">documentation</a> for installation and release information .</p>
<p>Although the documentation is quite comprehensive, I want to go over some very basic HTML definitions that will make your experience go a lot smoother.</p>
<ul>
<li>Elements: These are your main “tags” such as <code>&lt;h1&gt; Heading 1 &lt;/h1&gt;</code> or <code>&lt;p&gt; Wine is life.&lt;/p&gt;</code>. The basic structure of a page is:</li>
</ul>
<pre><code>&lt;html&gt;
&lt;body&gt;
  #body of your page
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>The <code><a href="https://rvest.tidyverse.org/reference/rename.html">rvest::html_nodes()</a></code> function is what you will use to specify which elements, specifically the CSS selector. For example, calling <code>html_nodes(myhtmldoc, ".CSS-selector span") %&gt;% html_text()</code> will retrieve the text associated with the specified <code>&lt;span&gt;</code> tag. If this doesn’t make sense right away, don’t worry you’ll see an example below.</p>
<ul>
<li>Attributes: These provide additional information for the element, such as an image source (<code>src</code>) or a link’s path (<code>href</code>). These are usually displayed as key/value pairs, i.e. <code>width="500"</code>. You will use <code><a href="https://rvest.tidyverse.org/reference/html_attr.html">rvest::html_attr("YOUR ATTRIBUTE")</a></code> if you need to get specific details from an attribute.</li>
</ul>
<p>Finally, it’s a good idea to familiarize yourself with the “Inspect” feature from your browser. This allows your to see the breakdown of any web-page your viewing. This is where you will also find the names for the elements and attributes you want to scrape!</p>
<p>(pro tip: use the "select element feature to jump directly to the element you’re looking for)</p>
<p><em>Note: <code>rvest</code> cannot handle JS, it only reads the HTML before JS loaded so some objects may not be possible to scrape with this package. However, if you have the inspect console open in your browser, go to the “Network” tab, refresh the page and try looking for a GET request made to an API (api may be in the URL). This is data stored in a JSON file which can be read using <code><a href="https://rdrr.io/pkg/jsonlite/man/fromJSON.html">jsonlite::fromJSON()</a></code></em></p>
<p>Don’t get intimidated. It’s quite simple.</p>
<div id="write-a-function-to-get-the-name-category-and-path-of-a-drug" class="section level3">
<h3 class="hasAnchor">
<a href="#write-a-function-to-get-the-name-category-and-path-of-a-drug" class="anchor"></a>Write a function to get the name, category and path of a drug</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-lib/conflicted">conflicted</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/conflicted/man/conflict_prefer.html">conflict_prefer</a></span><span class="op">(</span><span class="st">"filter"</span>, <span class="st">"dplyr"</span><span class="op">)</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://xml2.r-lib.org/">xml2</a></span><span class="op">)</span>  <span class="co"># read_html()</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rvest.tidyverse.org/">rvest</a></span><span class="op">)</span>  <span class="co"># html_nodes(), html_text()</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org">purrr</a></span><span class="op">)</span>  <span class="co"># map_dfr()</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org">stringr</a></span><span class="op">)</span>  <span class="co"># str_to_lower()</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/">tibble</a></span><span class="op">)</span>  <span class="co"># tibble(),</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span><span class="op">)</span>  <span class="co"># %&gt;%, bind_rows()</span>

<span class="va">get_drug_factsheets</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pg_num</span><span class="op">)</span><span class="op">{</span>
  <span class="va">category</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"https://www.dea.gov/factsheets?field_fact_sheet_category_target_id=All&amp;page="</span>, <span class="va">pg_num</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes</a></span><span class="op">(</span><span class="st">".teaser-title--drug_fact_sheet span"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">class</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"https://www.dea.gov/factsheets?field_fact_sheet_category_target_id=All&amp;page="</span>, <span class="va">pg_num</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes</a></span><span class="op">(</span><span class="st">".teaser-category--drug-category"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op">(</span><span class="op">)</span>
  <span class="co">#get correct path to factsheet</span>
  <span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"https://www.dea.gov/factsheets?field_fact_sheet_category_target_id=All&amp;page="</span>, <span class="va">pg_num</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes</a></span><span class="op">(</span><span class="st">".teaser-title--drug_fact_sheet a"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_attr.html">html_attr</a></span><span class="op">(</span><span class="st">"href"</span><span class="op">)</span>
  <span class="co">#return 1x2 tibble</span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span><span class="st">"class"</span> <span class="op">=</span> <span class="va">class</span>,
         <span class="st">"category"</span> <span class="op">=</span> <span class="va">category</span>,
         <span class="st">"fact_path"</span> <span class="op">=</span> <span class="va">path</span>
         <span class="op">)</span>
<span class="op">}</span>

<span class="va">dea_factsheets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">2</span>, <span class="va">get_drug_factsheets</span><span class="op">)</span></code></pre></div>
<p>This information gets us the drug’s category, class and path. We will use the <code>path</code> variable to get available brand names for that particular drug.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># function to pull the data - specifically the brand names of each of</span>
<span class="co">#   the drug types from their factsheets</span>
<span class="va">get_brand</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">drug_path</span>, <span class="va">drug_category</span><span class="op">)</span><span class="op">{</span>
  <span class="va">drug_brands</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"https://www.dea.gov"</span>, <span class="va">drug_path</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rvest.tidyverse.org/reference/rename.html">html_nodes</a></span><span class="op">(</span><span class="st">".field--what"</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># name of the div with the brand names</span>
    <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_text.html">html_text</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="st">"\n"</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># remove line breaks</span>
    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span><span class="op">(</span><span class="st">" "</span>, simplify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># split the vector into individual strings</span>
    <span class="va">.</span><span class="op">[</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"®"</span><span class="op">)</span><span class="op">]</span> <span class="op">%&gt;%</span>  <span class="co"># find the strings that include the registered trademark symbol and subset</span>
    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"[,|.]"</span><span class="op">)</span>  <span class="co"># remove extra characters</span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span><span class="st">"category"</span> <span class="op">=</span> <span class="va">drug_category</span>,
         <span class="st">"brands"</span> <span class="op">=</span> <span class="va">drug_brands</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">dea_brands</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">map2_dfr</a></span><span class="op">(</span><span class="va">dea_factsheets</span><span class="op">$</span><span class="va">fact_path</span>, <span class="va">dea_factsheets</span><span class="op">$</span><span class="va">category</span>, <span class="va">get_brand</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_data.html">use_data</a></span><span class="op">(</span><span class="va">dea_factsheets</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_data.html">use_data</a></span><span class="op">(</span><span class="va">dea_brands</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Raymond Balise, Layla Bouzoubaa, Gabriel Odom, Nathaniel Castor.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
